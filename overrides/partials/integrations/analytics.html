<!-- Determine analytics provider -->
{% if config.extra.analytics %}
  {% set provider = config.extra.analytics.provider %}
{% endif %}

<!-- Set up analytics provider -->
{% if provider %}
  {% include "partials/integrations/analytics/" ~ provider ~ ".html" %}

  <script>
    // Initialize Matomo's _paq array
    window._paq = window._paq || [];

    // Check initial consent and load analytics
    var consent = __md_get("__consent");
    if (consent && consent.analytics) {
      window._paq.push(['rememberCookieConsentGiven']); // Remember consent
      __md_analytics(); // Load Matomo if consent is given
    } else if (!consent || !consent.analytics) {
      window._paq.push(['forgetCookieConsentGiven']); // Forget consent
    }

    // Monitor local storage for changes in consent
    window.addEventListener("storage", function (event) {
      if (event.key === "__consent") {
        var updatedConsent = __md_get("__consent");

        if (updatedConsent && updatedConsent.analytics) {
          // Consent granted
          window._paq.push(['rememberCookieConsentGiven']);
          __md_analytics();
        } else {
          // Consent revoked or not set
          window._paq.push(['forgetCookieConsentGiven']);
          console.log("Analytics consent revoked. Cookies deleted.");
        }
      }
    });
  </script>

  <!-- Consent necessary -->
  {% if config.extra.consent %}
    <script>
      if (typeof __md_analytics !== "undefined") {
        var consent = __md_get("__consent");
        if (consent && consent.analytics) {
          __md_analytics();
        }
      }
    </script>

  <!-- Consent unnecessary -->
  {% else %}
    <script>
      if (typeof __md_analytics !== "undefined") {
        __md_analytics();
      }
    </script>
  {% endif %}
{% endif %}
